Steps to create environment:

helm upgrade --install keycloak bitnami/keycloak --values=keycloak.yaml

- add minio public client to keycloak
- add policy attribute to users allowed to use minio and add attribute mapper
  to minio client to allow access to minio using OpenID Connect
- adjust MINIO_IDENTITY_OPENID_CONFIG_URL minio.yaml to keycloak endpoint

helm upgrade --install minio minio/minio --values=minio.yaml

- add confidential jupyter client to keycloak
- adjust dask.yaml with actual endpoints and client secret of jupyter, keycloak and minio. here:
  - .90 - jupyter
  - .91 - keycloak
  - .92 - minio

jupyterhub:
  hub:
    extraEnv:
      OAUTH_CALLBACK_URL: "http://192.168.122.90/hub/oauth_callback"
      OAUTH2_AUTHORIZE_URL: "http://192.168.122.91/auth/realms/example.org/protocol/openid-connect/auth"
      OAUTH2_TOKEN_URL: "http://192.168.122.91/auth/realms/example.org/protocol/openid-connect/token"
    extraConfig:
      oauth2.py: |
[...]
                    endpoint_url='http://192.168.122.92',
[...]
        c.KubeGenericOAuthenticator.client_id = "jupyter"
        c.KubeGenericOAuthenticator.client_secret = "5f143785-8c14-4405-8281-e4318683223e"
        c.KubeGenericOAuthenticator.token_url = "http://192.168.122.91/auth/realms/example.org/protocol/openid-connect/token"
        c.KubeGenericOAuthenticator.userdata_url = "http://192.168.122.91/auth/realms/example.org/protocol/openid-connect/userinfo"

helm upgrade --install --render-subchart-notes dhub dask/daskhub --values=dask.yaml

Jupyterhub needs to be allowed to create secrets. This can be done manually by
editing the role to include secrets resources alongside pods after helm has run:

kubectl get role hub -o jsonpath="{.rules[*].resources}{'\n'}"
["secrets","pods","persistentvolumeclaims"] ["events"]

Alternatively, the RBAC template of jupyterhub helm chart contained within the
daskhub chart can be patched to create the role that way in the first place:

--- ../b/daskhub/charts/jupyterhub/templates/hub/rbac.yaml	2021-01-19 20:27:29.000000000 +0100
+++ charts/daskhub/charts/jupyterhub/templates/hub/rbac.yaml	2021-03-16 10:59:24.090045723 +0100
@@ -14,7 +14,7 @@
     {{- include "jupyterhub.labels" . | nindent 4 }}
 rules:
   - apiGroups: [""]       # "" indicates the core API group
-    resources: ["pods", "persistentvolumeclaims"]
+    resources: ["secrets", "pods", "persistentvolumeclaims"]
     verbs: ["get", "watch", "list", "create", "delete"]
   - apiGroups: [""]       # "" indicates the core API group
     resources: ["events"]

To do this, the daskhub chart can be unpacked into a subdirectory charts and
helm be run on the patched chart by changing the chart reference to
charts/daskhub:

helm upgrade --debug --install --render-subchart-notes dhub charts/daskhub --values=dask.yaml
